# Maintainer: Ivailo Monev <xakepa10@gmail.com>

# http://www.linuxfromscratch.org/blfs/view/svn/kde/kde-workspace.html

version=4.18.0
release=3
description="Provides the interface and basic tools for the KDE workspace"
depends=('kdelibs' 'libmtp' 'xorg-libraries' 'xorg-applications' 'xdg-utils'
         'xcb-util-renderutil' 'xcb-util-image' 'freetype2' 'libusbx'
         'xcb-util-keysyms' 'xcb-util-wm' 'busybox' 'libraw1394' 'ariya-icons'
         'kde-baseapps' 'ttf-dejavu')
makedepends=('cmake'  'xorg-protocol-headers')
optdepends=('libdbusmenu' 'gpsd')
sources=("https://github.com/fluxer/kde-workspace.git"
        'kdm.init' 'terminate-server.patch' 'etc-scripts.patch')
backup=('share/config/kdm/kdmrc')

export CFLAGS="$CFLAGS -Ofast" CXXFLAGS="$CXXFLAGS -Ofast"

src_prepare() {
    cd "$SOURCE_DIR/kde-workspace.git"

    # use standard directory for env/shutdown scripts
    patch -p0 -i "$SOURCE_DIR/etc-scripts.patch"

    # KDEBUG#202629
    patch -p0 -i "$SOURCE_DIR/terminate-server.patch"
}

src_compile() {
    cd "$SOURCE_DIR/kde-workspace.git"

    mkdir -p "$SOURCE_DIR/build" && cd "$SOURCE_DIR/build"
    cmake ../kde-workspace.git \
        -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_SKIP_INSTALL_RPATH=ON \
        -DCMAKE_INSTALL_PREFIX=/usr \
        -DSYSCONF_INSTALL_DIR=/etc \
        -DWITH_DBusMenuQt=$OPTIONAL_LIBDBUSMENU_BOOL \
        -DWITH_LibGPS=$OPTIONAL_GPSD_BOOL
    make
}

src_check() {
    cd "$SOURCE_DIR/build"
    make test
}

src_install() {
    cd "$SOURCE_DIR/build"
    make DESTDIR="$INSTALL_DIR" install

    install -vdm755 "$INSTALL_DIR/usr/share/xsessions/"
    ln -vsf /usr/share/apps/kdm/sessions/kde-plasma{,-safe}.desktop \
      "$INSTALL_DIR/usr/share/xsessions/"
    install -vdm755 "$INSTALL_DIR/etc/kde4/"{env,shutdown}

    install -vd -g 135 -o 135 "$INSTALL_DIR/var/lib/kdm"

    ln -vsf /usr/lib/kde4/libexec/kdesu "$INSTALL_DIR/usr/bin/kdesu"

    # install init script
    install -vDm744 "$SOURCE_DIR/kdm.init" "$INSTALL_DIR/etc/init.d/kdm"
}

post_install() {
    if ! getent group kdm; then
        echo " >> Adding kdm group..."
        addgroup -g 135 kdm
    fi

    if ! getent passwd kdm; then
        echo " >> Adding kdm user..."
        adduser -D -u 135 -G kdm -h /var/lib/kdm -s /bin/false kdm 
    fi
    chown -R 135:135 var/lib/kdm

    genkdmconf

    rc-update add kdm default
}

post_upgrade() {
    post_install
}

post_remove() {
    if getent passwd kdm; then
        echo " >> Deleting kdm user..."
        deluser kdm
    fi

    if getent group kdm; then
        echo " >> Deleting kdm group..."
        delgroup kdm
    fi

    rm -rf usr/share/apps/kdm/faces

    rc-update del kdm default
}
