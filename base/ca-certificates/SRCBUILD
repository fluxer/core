# Maintainer: Ivailo Monev <xakepa10@gmail.com>

# http://www.linuxfromscratch.org/blfs/view/svn/postlfs/cacerts.html

version=20200601
description='Common CA certificates'
depends=('bash' 'openssl' 'busybox')
backup=('etc/ca-certificates.conf')
makedepends=('python')
sources=("http://ftp.debian.org/debian/pool/main/c/ca-certificates/ca-certificates_$version.tar.xz")

src_compile() {
    cd "$SOURCE_DIR/work"
    make CERTSDIR=/usr/share/ca-certificates
}

src_install() {
    cd "$SOURCE_DIR/work"

    install -vdm755 "$INSTALL_DIR/"{etc/ca-certificates/update.d,/usr/{sbin,share/ca-certificates},etc/ssl/certs}
    make CERTSDIR=/usr/share/ca-certificates DESTDIR="$INSTALL_DIR" install
    install -vDm644 sbin/update-ca-certificates.8 "$INSTALL_DIR/usr/share/man/man8/update-ca-certificates.8"

    (
        echo "# Automatically generated by ca-certificates-$version"
        echo "# see update-ca-certificates man page"
        echo "# "
        find "$INSTALL_DIR/usr/share/ca-certificates" -name '*.crt' | sort | sed "s|$INSTALL_DIR/usr/share/ca-certificates||g"
    ) > "$INSTALL_DIR/etc/ca-certificates.conf"
}


post_install() {
    echo ' >> Updating certificates. This might take a while...'
    LC_ALL=C update-ca-certificates --fresh
}

post_upgrade() {
    post_install
}

pre_remove() {
    # clean up certificates
    local _backup=$(mktemp)
    mv etc/ca-certificates.conf ${_backup}
    echo > etc/ca-certificates.conf
    post_install
    mv ${_backup} etc/ca-certificates.conf
}

post_remove() {
    # remove the cert file if it is empty
    [[ -f etc/ssl/certs/ca-certificates.crt ]] || rm -f etc/ssl/certs/ca-certificates.crt
}
