# Maintainer:  Ivailo Monev <xakepa10@gmail.com>

version=0.42.1
description='Dependency based init system that works with sysvinit.'
depends=('sysvinit' 'busybox')
optdepends=('net-tools')
backup=(etc/inittab
        etc/rc.conf
        etc/conf.d/bootmisc
        etc/conf.d/consolefont
        etc/conf.d/devfs
        etc/conf.d/dmesg
        etc/conf.d/fsck
        etc/conf.d/hostname
        etc/conf.d/hwclock
        etc/conf.d/keymaps
        etc/conf.d/killprocs
        etc/conf.d/localmount
        etc/conf.d/modules
        etc/conf.d/netmount
        etc/conf.d/network
        etc/conf.d/staticroute
        etc/conf.d/tmpfiles
        etc/conf.d/urandom
        etc/conf.d/tmpfiles)
sources=("https://github.com/OpenRC/openrc/archive/$version.tar.gz"
        'https://github.com/OpenRC/opentmpfiles/archive/0.2.tar.gz'
        'einfo-color.patch'
        'inittab')
options=('!mirror')

_makeargs=(BRANDING='Entropy GNU/Linux')
# _makeargs+=(MKPAM=pam)
_makeargs+=(MKSELINUX=no)
_makeargs+=(MKNET=newnet)
_makeargs+=(MKTERMCAP=ncurses)
_makeargs+=(PKG_PREFIX="")
_makeargs+=(LIBDIR=/lib)
_makeargs+=(SHLIBDIR=/lib)
_makeargs+=(LIBEXECDIR=/lib/rc)
_makeargs+=(BINDIR=/bin)
_makeargs+=(SBINDIR=/sbin)
_makeargs+=(SYSCONFDIR=/etc)

src_prepare() {
    cd "$SOURCE_DIR/openrc-$version"
    patch -Np1 -i "$SOURCE_DIR/einfo-color.patch"
}

src_compile() {
    cd "$SOURCE_DIR/openrc-$version"
    make "${_makeargs[@]}"
}

src_install() {
    cd "$SOURCE_DIR/openrc-$version"

    make DESTDIR="$INSTALL_DIR" "${_makeargs[@]}" install

    cd "$SOURCE_DIR/opentmpfiles-0.2"
    make DESTDIR="$INSTALL_DIR" install

    install -vDm744 openrc/opentmpfiles-dev.confd \
        "$INSTALL_DIR/etc/conf.d/opentmpfiles-dev"
    install -vDm744 openrc/opentmpfiles-setup.confd \
        "$INSTALL_DIR/etc/conf.d/opentmpfiles-setup"

    install -vDm744 openrc/opentmpfiles-dev.initd \
        "$INSTALL_DIR/etc/init.d/opentmpfiles-dev"
    install -vDm744 openrc/opentmpfiles-setup.initd \
        "$INSTALL_DIR/etc/init.d/opentmpfiles-setup"

    install -vm644 "$SOURCE_DIR/inittab" "$INSTALL_DIR/etc/inittab"
}

post_install() {
    rc-update add opentmpfiles-dev sysinit
    rc-update add opentmpfiles-setup boot
}

post_upgrade() {
    post_install
}
