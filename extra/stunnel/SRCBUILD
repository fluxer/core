# Maintainer: Ivailo Monev <xakepa10@gmail.com>

# FIXME: openrc service is bogus
# http://www.linuxfromscratch.org/blfs/view/svn/postlfs/stunnel.html

version=5.36
description="A program that allows you to encrypt arbitrary TCP connections inside SSL"
depends=('openssl')
sources=("https://www.stunnel.org/downloads/stunnel-$version.tar.gz"
        'stunnel.init' 'stunnel.tmpfiles')

src_prepare() {
    cd "$SOURCE_DIR/stunnel-$version"
    # For some systems with binutils versions prior to 2.25, configure may fail.
    sed -i '/LDFLAGS.*static_flag/ s/^/#/' configure
}

src_compile() {
    cd "$SOURCE_DIR/stunnel-$version"

    ./configure --prefix=/usr \
        --sysconfdir=/etc \
        --localstatedir=/var \
        --enable-ipv6 \
        --disable-libwrap \
        --with-ssl=/usr \
        --disable-systemd
    make
}

src_install() {
    cd "$SOURCE_DIR/stunnel-$version"

    make DESTDIR="$INSTALL_DIR" install

    cat > "$INSTALL_DIR/etc/stunnel/stunnel.conf" << "EOF"
; File: /etc/stunnel/stunnel.conf

; Note: The pid and output locations are relative to the chroot location.

pid    = /run/stunnel.pid
chroot = /var/lib/stunnel
client = no
setuid = stunnel
setgid = stunnel
cert   = /etc/stunnel/stunnel.pem

;debug = 7
;output = stunnel.log

;[https]
;accept  = 443
;connect = 80
;; "TIMEOUTclose = 0" is a workaround for a design flaw in Microsoft SSL
;; Microsoft implementations do not use SSL close-notify alert and thus
;; they are vulnerable to truncation attacks
;TIMEOUTclose = 0


EOF
    chmod -v 644 "$INSTALL_DIR/etc/stunnel/stunnel.conf"

    # install init script
    install -vDm744 "$SOURCE_DIR/stunnel.init" "$INSTALL_DIR/etc/init.d/stunnel"
    install -vDm644 "$SOURCE_DIR/stunnel.tmpfiles" "$INSTALL_DIR/etc/tmpfiles.d/stunnel.conf"
}


post_install() {
    if ! getent group stunnel; then
        echo " >> Adding stunnel group..."
        addgroup -g 51 stunnel
    fi

    if ! getent passwd stunnel; then
        echo " >> Adding stunnel user..."
        adduser -D -g "stunnel Daemon" -h /var/lib/stunnel -G stunnel \
            -s /bin/false -u 51 stunnel
    fi
}

post_upgrade() {
    post_install
}

post_remove() {
    if getent passwd stunnel; then
        echo " >> Deleting stunnel user..."
        deluser stunnel
    fi

    if getent group stunnel; then
        echo " >> Deleting stunnel group..."
        delgroup stunnel
    fi
}
