# Maintainer: Ivailo Monev <xakepa10@gmail.com>

# TODO: avahi
# http://www.linuxfromscratch.org/blfs/view/svn/pst/sane.html

version=1.0.25
description="Scanner Access Now Easy"
depends=('libtiff' 'libgphoto2' 'libjpeg-turbo' 'libusbx' 'cups' 'libieee1284' 'bash' 'net-snmp')
optdepends=('gtk2')
backup=('etc/xinetd.d/sane')
sources=("http://fossies.org/linux/misc/sane-backends-$version.tar.gz"
        'saned.init' 'saned.conf'
        'network.patch')

src_compile() {
    cd "$SOURCE_DIR/sane-backends-$version"

    # fix http://vasks.debian.org/tracker/?func=detail&atid=410366&aid=313760&group_id=30186
    patch -Np1 -i "$SOURCE_DIR/network.patch"

    autoreconf
    ./configure --prefix=/usr \
        --sysconfdir=/etc \
        --localstatedir=/var \
        --with-docdir=/usr/share/doc/sane \
        --with-group=scanner \
        --enable-pthread \
        --enable-libusb_1_0 \
        --disable-locking \
        --disable-rpath
    make
}

src_check() {
    cd "$SOURCE_DIR/sane-backends-$version"
    sed -i -e 's/Jul 31 07:52:48/Oct  7 08:58:33/'      \
       -e 's/1.0.24git/1.0.24/'                     \
       testsuite/tools/data/db.ref                  \
       testsuite/tools/data/html-mfgs.ref           \
       testsuite/tools/data/usermap.ref             \
       testsuite/tools/data/html-backends-split.ref \
       testsuite/tools/data/udev+acl.ref            \
       testsuite/tools/data/udev.ref
    make check
}

src_install() {
    cd "$SOURCE_DIR/sane-backends-$version"
    make DESTDIR="$INSTALL_DIR" install

    # fix hp officejets
    echo "#hpaio" >> "$INSTALL_DIR/etc/sane.d/dll.conf"

    # install udev files
    install -vDm0644 tools/udev/libsane.rules "$INSTALL_DIR/lib/udev/rules.d/49-sane.rules"
    sed -i 's|NAME="%k", ||g' "$INSTALL_DIR/lib/udev/rules.d/49-sane.rules"

    # Install the pkgconfig file
    install -vDm644 tools/sane-backends.pc "$INSTALL_DIR/usr/lib/pkgconfig/sane-backends.pc"

    # install init script
    install -vDm744 "$SOURCE_DIR/saned.init" "$INSTALL_DIR/etc/init.d/saned"
    install -vDm644 "$SOURCE_DIR/saned.conf" "$INSTALL_DIR/etc/conf.d/saned"
}

post_install() {
    if ! getent group scanner; then
        echo " >> Adding scanner group..."
        addgroup -S -g 70 scanner
    fi
}

post_upgrade() {
    post_install
}

post_remove() {
    if getent group scanner; then
        echo " >> Deleting scanner group"
        delgroup scanner
    fi
}