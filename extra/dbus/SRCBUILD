# Maintainer: Ivailo Monev <xakepa10@gmail.com>

# http://www.linuxfromscratch.org/blfs/view/svn/general/dbus.html

version=1.13.6
description="Freedesktop.org message bus system"
depends=('expat' 'busybox' 'filesystem' 'xorg-libraries')
makedepends=('xorg-protocol-headers')
sources=("http://dbus.freedesktop.org/releases/dbus/dbus-$version.tar.gz"
        "http://dbus.freedesktop.org/releases/dbus/dbus-$version.tar.gz.asc"
        '30-dbus' 'dbus.init')
pgpkeys=('4DE8FF2A63C7CC90')

src_compile() {
    cd "$SOURCE_DIR/dbus-$version"

    ./configure --prefix=/usr \
        --sysconfdir=/etc \
        --localstatedir=/var \
        --with-console-auth-dir=/run/console/ \
        --without-systemdsystemunitdir \
        --disable-systemd \
        --disable-static \
        --disable-xml-docs \
        --disable-doxygen-docs \
        --with-dbus-user=messagebus
    make
}

src_check() {
    cd "$SOURCE_DIR/dbus-$version"
    make check
}

src_install(){
    cd "$SOURCE_DIR/dbus-$version"

    # if messagebus group is not present dbus-daemon-launch-helper
    # will be owned by root, which is bad
    post_install

    make DESTDIR="$INSTALL_DIR" install

    rm -rf "$INSTALL_DIR/var/run"

    install -vDm755 "$SOURCE_DIR/30-dbus" "$INSTALL_DIR/etc/X11/xinit/xinitrc.d/30-dbus"
    install -vDm755 "$SOURCE_DIR/dbus.init" "$INSTALL_DIR/etc/init.d/dbus"
}


post_install() {
    if ! getent group messagebus; then
        echo " >> Adding messagebus group"
        addgroup -S messagebus
    fi

    if ! getent passwd messagebus; then
        echo " >> Adding messagebus user"
        adduser -S -D -g "D-Bus Message Daemon User" -h /var/run/dbus -G messagebus -s /bin/false messagebus
    fi

    # guard from src_install()
    if [ -f /etc/init.d/dbus ];then
        rc-update add dbus default
    fi
}

post_upgrade() {
    post_install
}

post_remove() {
    if getent passwd messagebus; then
        echo " >> Deleting messagebus user"
        deluser messagebus
    fi

    if getent group messagebus; then
        echo " >> Deleting messagebus group"
        delgroup messagebus
    fi

    rc-update del dbus default
}
