# Maintainer: Ivailo Monev <xakepa10@gmail.com>

# http://www.linuxfromscratch.org/blfs/view/svn/server/mariadb.html
# https://raw.githubusercontent.com/funtoo/funtoo-mysql/master/eclass/mysql-multilib.eclass

version=10.4.17
description='Fast SQL database server, drop-in replacement for MySQL'
makedepends=('cmake' 'openssl' 'zlib' 'libaio' 'libxml2' 'pcre')
optdepends=('boost')
sources=("https://downloads.mariadb.org/interstitial/mariadb-$version/source/mariadb-$version.tar.gz"
        'my.conf' 'mariadb.init' 'mariadb.tmpfiles')
backup=('etc/mysql/my.cnf'
    'etc/tmpfiles.d/mariadb.conf')

src_compile() {
    cd "$SOURCE_DIR/mariadb-$version"

    mkdir -p "$SOURCE_DIR/build" && cd "$SOURCE_DIR/build"
    cmake ../mariadb-$version \
        -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_INSTALL_PREFIX=/usr \
        -DINSTALL_DOCDIR=share/doc/mariadb \
        -DINSTALL_DOCREADMEDIR=share/doc/mariadb \
        -DINSTALL_MANDIR=share/man \
        -DINSTALL_MYSQLSHAREDIR=share/mysql \
        -DINSTALL_MYSQLTESTDIR=share/mysql/test \
        -DINSTALL_PLUGINDIR=lib/mysql/plugin \
        -DINSTALL_SBINDIR=sbin \
        -DINSTALL_SCRIPTDIR=bin \
        -DINSTALL_SQLBENCHDIR=share/mysql/bench \
        -DINSTALL_SUPPORTFILESDIR=share/mysql \
        -DMYSQL_DATADIR=/srv/mysql \
        -DMYSQL_UNIX_ADDR=/run/mysqld/mysqld.sock \
        -DWITH_EXTRA_CHARSETS=complex \
        -DWITH_EMBEDDED_SERVER=ON \
        -DSKIP_TESTS=ON \
        -DWITH_UNIT_TESTS=OFF \
        -DWITH_UNITTEST=OFF
    make
}

src_install() {
    cd "$SOURCE_DIR/build"

    make DESTDIR="$INSTALL_DIR" install

    install -vDm644 "$SOURCE_DIR/my.conf" "$INSTALL_DIR/etc/mysql/my.cnf"
    install -vDm744 "$SOURCE_DIR/mariadb.init" \
        "$INSTALL_DIR/etc/init.d/mariadb"
    install -vDm644 "$SOURCE_DIR/mariadb.tmpfiles" \
        "$INSTALL_DIR/etc/tmpfiles.d/mariadb.conf"

    # trim the fat
    rm -vfr "$INSTALL_DIR/usr/share/mysql/test"
    rm -vfr "$INSTALL_DIR/usr/share/mysql/bench"
    rm -vf "$INSTALL_DIR/usr/lib/"*.a
}

post_install(){
    if ! getent group mysql; then
        echo " >> Adding mysql group"
        addgroup -S -g 40 mysql
    fi

    if ! getent passwd mysql; then
        echo " >> Adding mysql user"
        adduser -S -D -g "MySQL Server" -h /srv/mysql -G mysql -s /bin/false -u 40 mysql
    fi

    if [ ! -e /srv/mysql ]; then
        echo " >> Setting up data directory"
        install -vdm700 /srv/mysql
        mysql_install_db --basedir=/usr --datadir=/srv/mysql --user=mysql
        chown -vR mysql:mysql /srv/mysql
    fi
}

post_upgrade(){
    post_install
}

post_remove(){
    if getent passwd mysql; then
        echo " >> Deleting mysql user"
        deluser mysql
    fi

    if getent group mysql; then
        echo " >> Deleting mysql group"
        delgroup mysql
    fi
}
