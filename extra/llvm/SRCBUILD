# Maintainer: Ivailo Monev <xakepa10@gmail.com>

# http://www.linuxfromscratch.org/blfs/view/svn/general/llvm.html

version=10.0.1
description="Low Level Virtual Machine"
depends=('perl' 'python' 'libffi' 'zlib')
makedepends=('ncurses' 'cmake')
sources=("https://github.com/llvm/llvm-project/releases/download/llvmorg-$version/llvm-$version.src.tar.xz"
        "https://github.com/llvm/llvm-project/releases/download/llvmorg-$version/clang-$version.src.tar.xz"
        "https://github.com/llvm/llvm-project/releases/download/llvmorg-$version/compiler-rt-$version.src.tar.xz"
        "https://github.com/llvm/llvm-project/releases/download/llvmorg-$version/clang-tools-extra-$version.src.tar.xz"
        "https://github.com/llvm/llvm-project/releases/download/llvmorg-$version/llvm-$version.src.tar.xz.sig"
        "https://github.com/llvm/llvm-project/releases/download/llvmorg-$version/clang-$version.src.tar.xz.sig"
        "https://github.com/llvm/llvm-project/releases/download/llvmorg-$version/compiler-rt-$version.src.tar.xz.sig"
        "https://github.com/llvm/llvm-project/releases/download/llvmorg-$version/clang-tools-extra-$version.src.tar.xz.sig")
pgpkeys=('11E521D646982372EB577A1F8F0871F202119294'
        'B6C8F98282B944E3B0D5C2530FC3042E345AD05D'
        '474E22316ABF4785A88C6E8EA2C794A986419D8A')

src_prepare() {
    cd "$SOURCE_DIR/llvm-$version.src"

    # At the present, clang must reside inside the LLVM source code tree to build
    # See http://llvm.org/bugs/show_bug.cgi?id=4840
    cp -a "$SOURCE_DIR/clang-$version.src" tools/clang
    cp -a "$SOURCE_DIR/compiler-rt-$version.src" projects/compiler-rt
    # cp -a "$SOURCE_DIR/clang-tools-extra-$version.src" tools/clang/tools/extra
}

src_compile() {
    cd "$SOURCE_DIR/llvm-$version.src"

    # Force the use of GCC instead of clang and vise-versa
    # export CC=gcc CXX=g++
    # export CC=clang CXX=clang++

    # http://llvm.org/docs/CMake.html
    mkdir -vp "$SOURCE_DIR/build" && cd "$SOURCE_DIR/build"
    cmake -DCMAKE_INSTALL_PREFIX=/usr \
        -DCMAKE_BUILD_TYPE=Release \
        -DLLVM_TARGETS_TO_BUILD="host;AMDGPU" \
        -DLLVM_BUILD_EXAMPLES=OFF \
        -DLLVM_BUILD_DOCS=OFF \
        -DLLVM_BUILD_TESTS=OFF \
        -DLLVM_ENABLE_FFI=ON \
        -DLLVM_ENABLE_ZLIB=ON \
        -DLLVM_ENABLE_RTTI=ON \
        -DBUILD_SHARED_LIBS=ON \
        ../llvm-$version.src
    make
}

src_check() {
    cd "$SOURCE_DIR/build"
    make check
}

src_install() {
    cd "$SOURCE_DIR/build"
    make DESTDIR="$INSTALL_DIR" install
}
