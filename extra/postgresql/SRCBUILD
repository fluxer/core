version=9.4.5
description="A sophisticated object-relational DBMS"
depends=('libxml2' 'readline' 'openssl')
makedepends=('krb5' 'python' 'perl')
sources=("http://ftp.postgresql.org/pub/source/v$version/postgresql-$version.tar.bz2"
    'postgresql-run-socket.patch'
    'postgresql.tmpfiles'
    'postgresql-check-db-dir')

src_prepare() {
    cd "$SOURCE_DIR/postgresql-$version"

    patch -Np1 -i ../postgresql-run-socket.patch
}

src_compile() {
    cd "$SOURCE_DIR/postgresql-$version"

    ./configure --prefix=/usr \
        --mandir=/usr/share/man \
        --datadir=/usr/share/postgresql \
        --sysconfdir=/etc \
        --with-gssapi \
        --with-libxml \
        --with-openssl \
        --with-perl \
        --with-system-tzdata=/usr/share/zoneinfo \
        --enable-thread-safety \
        --disable-nls

    make world
}

src_install() {
  cd "$SOURCE_DIR/postgresql-$version"

  make DESTDIR="$INSTALL_DIR" install

  install -vDm644 "$SOURCE_DIR/postgresql.tmpfiles" \
    "$INSTALL_DIR/etc/tmpfiles.d/postgresql.conf"
  install -vDm755 "$SOURCE_DIR/postgresql-check-db-dir" \
    "$INSTALL_DIR/usr/bin/postgresql-check-db-dir"
}


post_install() {
    mkdir -vp '/var/lib/postgres'

    if ! getent group postgres; then
        echo " >> Adding postgres group"
        addgroup -S -g 88 postgres
    fi

    if ! getent passwd postgres; then
        echo " >> Adding postgres user"
        adduser -S -D -g "PostgreSQL user" -h /var/lib/postgres -u 88 -G postgres -s /bin/bash postgres
    fi

    if [ ! -d '/var/lib/postgres/data' ]; then
        mkdir -vp /var/lib/postgres/data
        chown -v postgres:postgres /var/lib/postgres/data
    fi
}

post_upgrade() {
    post_install
}

post_remove() {
    if getent passwd postgres; then
        echo " >> Deleting postgres user"
        deluser postgres
    fi

    if getent group postgres; then
        echo " >> Deleting postgres group"
        delgroup postgres
    fi
}
