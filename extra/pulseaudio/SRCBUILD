
# TODO: optdepends - libasyncns, lirc, orc, webrtc-audio-processing, fftw, jack, sbc, gconf

description="A featureful, general-purpose sound server"
version=6.0
makedepends=('json-c' 'libcap' 'libsndfile' 'speex' 'xorg-libraries' 'dbus'
        'alsa-lib' 'openssl')
optdepends=('check' 'avahi' 'bluez' 'gtk3' 'valgrind')
sources=("http://freedesktop.org/software/pulseaudio/releases/pulseaudio-$version.tar.xz")
backup=('etc/pulse/daemon.conf'
        'etc/pulse/default.pa'
        'etc/pulse/system.pa')

src_compile() {
    cd "$SOURCE_DIR/pulseaudio-$version"

    ./configure --prefix=/usr \
        --sysconfdir=/etc \
        --libexecdir=/usr/lib \
        --localstatedir=/var \
        --with-udev-rules-dir=/lib/udev/rules.d \
        --disable-tcpwrap \
        --disable-bluez4 \
        --disable-rpath \
        --disable-default-build-tests

    # fight unused direct deps
    sed -i -e 's/ -shared / -Wl,-O1,--as-needed\0/g' libtool

    make
}

src_install() {
    cd "$SOURCE_DIR/pulseaudio-$version"

    make -j1 DESTDIR="$INSTALL_DIR" install

    # Speed up pulseaudio shutdown so that it exits immediately with
    # the last user session (module-systemd-login keeps it alive)
    sed -e '/exit-idle-time/iexit-idle-time=0' \
        -i "$INSTALL_DIR/etc/pulse/daemon.conf"

    # Disable cork-request module, can result in e.g. media players unpausing
    # when there's a Skype call incoming
    sed -e 's|/usr/bin/pactl load-module module-x11-cork-request|#&|' \
        -i "$INSTALL_DIR/usr/bin/start-pulseaudio-x11"
}
