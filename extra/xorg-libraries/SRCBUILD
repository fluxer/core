# Maintainer: Ivailo Monev <xakepa10@gmail.com>

# http://www.linuxfromscratch.org/blfs/view/svn/x/x7lib.html

version=1.18.4
release=3
description="X.Org routines libraries"
depends=('glibc' 'eudev' 'fontconfig' 'freetype2' 'zlib')
makedepends=('xorg-makeutils' 'xorg-protocol-headers' 'xorg-makeutils'
        'fontconfig' 'freetype2' 'gettext')
sources=("http://xorg.freedesktop.org/releases/individual/lib/libXau-1.0.8.tar.bz2"
        "http://xorg.freedesktop.org/releases/individual/xcb/libxcb-1.12.tar.bz2"
        "http://xorg.freedesktop.org/releases/individual/lib/xtrans-1.3.5.tar.bz2"
        "http://xorg.freedesktop.org/releases/individual/lib/libX11-1.6.4.tar.bz2"
        "http://xorg.freedesktop.org/releases/individual/lib/libXext-1.3.3.tar.bz2"
        "http://xorg.freedesktop.org/releases/individual/lib/libFS-1.0.7.tar.bz2"
        "http://xorg.freedesktop.org/releases/individual/lib/libICE-1.0.9.tar.bz2"
        "http://xorg.freedesktop.org/releases/individual/lib/libSM-1.2.2.tar.bz2"
        "http://xorg.freedesktop.org/releases/individual/lib/libXScrnSaver-1.2.2.tar.bz2"
        "http://xorg.freedesktop.org/releases/individual/lib/libXt-1.1.5.tar.bz2"
        "http://xorg.freedesktop.org/releases/individual/lib/libXmu-1.1.2.tar.bz2"
        "http://xorg.freedesktop.org/releases/individual/lib/libXp-1.0.3.tar.bz2"
        "http://xorg.freedesktop.org/releases/individual/lib/libXpm-3.5.11.tar.bz2"
        "http://xorg.freedesktop.org/releases/individual/lib/libXaw-1.0.13.tar.bz2"
        "http://xorg.freedesktop.org/releases/individual/lib/libXfixes-5.0.3.tar.bz2"
        "http://xorg.freedesktop.org/releases/individual/lib/libXcomposite-0.4.4.tar.bz2"
        "http://xorg.freedesktop.org/releases/individual/lib/libXrender-0.9.10.tar.bz2"
        "http://xorg.freedesktop.org/releases/individual/lib/libXcursor-1.1.14.tar.bz2"
        "http://xorg.freedesktop.org/releases/individual/lib/libXdamage-1.1.4.tar.bz2"
        "http://xorg.freedesktop.org/releases/individual/lib/libfontenc-1.1.3.tar.bz2"
        "http://xorg.freedesktop.org/releases/individual/lib/libXfont-1.5.2.tar.bz2"
        "http://xorg.freedesktop.org/releases/individual/lib/libXfont2-2.0.1.tar.bz2"
        "http://xorg.freedesktop.org/releases/individual/lib/libXft-2.3.2.tar.bz2"
        "http://xorg.freedesktop.org/releases/individual/lib/libXi-1.7.7.tar.bz2"
        "http://xorg.freedesktop.org/releases/individual/lib/libXinerama-1.1.3.tar.bz2"
        "http://xorg.freedesktop.org/releases/individual/lib/libXrandr-1.5.1.tar.bz2"
        "http://xorg.freedesktop.org/releases/individual/lib/libXres-1.0.7.tar.bz2"
        "http://xorg.freedesktop.org/releases/individual/lib/libXtst-1.2.3.tar.bz2"
        "http://xorg.freedesktop.org/releases/individual/lib/libXv-1.0.11.tar.bz2"
        "http://xorg.freedesktop.org/releases/individual/lib/libXvMC-1.0.10.tar.bz2"
        "http://xorg.freedesktop.org/releases/individual/lib/libXxf86dga-1.1.4.tar.bz2"
        "http://xorg.freedesktop.org/releases/individual/lib/libXxf86vm-1.1.4.tar.bz2"
        "http://xorg.freedesktop.org/releases/individual/lib/libdmx-1.1.3.tar.bz2"
        "http://xorg.freedesktop.org/releases/individual/lib/libpciaccess-0.13.4.tar.bz2"
        "http://xorg.freedesktop.org/releases/individual/lib/libxkbfile-1.0.9.tar.bz2"
        "http://xorg.freedesktop.org/releases/individual/lib/libxshmfence-1.2.tar.bz2"
        "http://xorg.freedesktop.org//releases/individual/lib/libXdmcp-1.1.2.tar.bz2")

_packages=(libXau libxcb xtrans libX11 libXext libFS libICE libSM libXScrnSaver libXt libXmu \
        libXp libXpm libXaw libXfixes libXcomposite libXrender libXcursor libXdamage \
        libfontenc libXfont libXfont2 libXft libXi libXinerama libXrandr libXres libXtst \
        libXv libXvMC libXxf86dga libXxf86vm libdmx libpciaccess libxkbfile libxshmfence libXdmcp)
src_compile() {
    # some libraries build with clang cause crashes
    export CC=gcc CXX=g++

    for _pkg in "${_packages[@]}";do
        cd "$SOURCE_DIR/$_pkg-"*
        echo "Configuring $_pkg..."
        case "$_pkg" in
            libxcb)        sed -e "s/pthread-stubs//" -i configure.ac
                                autoreconf -fiv
                                ./configure --prefix=/usr \
                                    --sysconfdir=/etc \
                                    --localstatedir=/var \
                                    --disable-static \
                                    --enable-xinput \
                                    --enable-xkb \
                                    --without-doxygen ;;
            libXt)    ./configure --prefix=/usr \
                                    --sysconfdir=/etc \
                                    --localstatedir=/var \
                                    --disable-static \
                                    --with-appdefaultdir=/etc/X11/app-defaults ;;
            *)               ./configure --prefix=/usr \
                                    --sysconfdir=/etc \
                                    --localstatedir=/var \
                                    --disable-static ;;
        esac
        echo "Compiling $_pkg..."
        make

        # bootstrapping requires local installation
        if [ ! -d "/var/local/spm/xorg-libraries" ];then
            echo "Installing $_pkg (local)..."
            make install
            ldconfig
        fi
    done
}

src_check() {
    for _pkg in "${_packages[@]}";do
        cd "$SOURCE_DIR/$_pkg-"*
        echo "Checking $_pkg..."
        make check
    done
}

src_install() {
    for _pkg in "${_packages[@]}";do
        cd "$SOURCE_DIR/$_pkg-"*
        echo "Installing $_pkg (package)..."
        make DESTDIR="$INSTALL_DIR" install
    done

    # in case of bootstrapping
    if [ ! -d "/var/local/spm/xorg-libraries" ];then
        find /usr/share/man/ -type f ! -name '*.gz' -delete
    fi

    # fix wrong permissions
    chown -Rv root:root "$INSTALL_DIR/usr/share/doc/libxcb/tutorial/"
}

